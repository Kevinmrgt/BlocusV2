# Story 2.4: Gym Header & Switching

## Status

**Ready for Review**

---

## Story

**As a** user,
**I want** to see my current gym in the header and be able to change it,
**so that** I can switch gyms without restarting the app.

---

## Acceptance Criteria

1. Header sur l'ecran Home affichant le nom de la salle selectionnee
2. Tap sur le header ouvre un modal ou navigue vers la carte
3. Selection d'une nouvelle salle met a jour la preference et recharge les donnees
4. Possibilite de changer de salle egalement depuis les parametres du profil

---

## Tasks / Subtasks

- [x] **Task 1: Review Existing Header Implementation** (AC: 1, 2, 3)
  - [x] Verify HomeScreen header shows gym name (already implemented in Story 2.2)
  - [x] Verify tapping header navigates to map (already implemented in Story 2.2)
  - [x] Verify new gym selection updates preference (already implemented in Story 2.2)
  - [x] Document any gaps between current implementation and ACs

- [x] **Task 2: Extract GymHeader Component for Reuse** (AC: 1, 4)
  - [x] Create `src/components/gym/GymHeader.tsx`
  - [x] Move header logic from HomeScreen to reusable component
  - [x] Props: `gymName`, `onChangeGym`
  - [x] Update HomeScreen to use GymHeader component

- [x] **Task 3: Add Gym Switching to ProfileScreen** (AC: 4)
  - [x] Update `src/screens/profile/ProfileScreen.tsx`
  - [x] Add a "Salle actuelle" section showing selected gym
  - [x] Add "Changer de salle" button
  - [x] Implement navigation to GymMapScreen from Profile
  - [x] Handle gym selection returning to previous screen

- [x] **Task 4: Update Navigation for Profile Gym Switch** (AC: 4)
  - [x] Ensure ProfileScreen can navigate to GymMapScreen
  - [x] Consider using modal presentation or cross-tab navigation
  - [x] Handle navigation state after gym selection from Profile

- [x] **Task 5: Write Unit Tests** (AC: All)
  - [x] Test GymHeader component renders correctly
  - [x] Test ProfileScreen shows current gym
  - [x] Test ProfileScreen change gym navigation
  - [x] Verify existing HomeScreen tests still pass

- [x] **Task 6: Verification & Integration Testing**
  - [x] Run `npx tsc --noEmit` - verify no type errors
  - [x] Run `npm run lint` - verify no lint errors
  - [x] Run `npm test` - verify all tests pass
  - [x] Manual test: HomeScreen header displays gym name
  - [x] Manual test: Tap HomeScreen header navigates to map
  - [x] Manual test: ProfileScreen shows current gym
  - [x] Manual test: Tap "Changer de salle" in Profile navigates to map

---

## Dev Notes

### Previous Story Context (Story 2.3)
[Source: docs/stories/2.3.story.md]

- Tab Navigation implemented with 3 tabs: Accueil, Classement, Profil
- MainTabs.tsx updated with House, Trophy, User icons
- LeaderboardScreen and ProfileScreen are placeholder screens
- 40 tests passing

### Previous Story Context (Story 2.2)
[Source: docs/stories/2.2.story.md]

- HomeScreen created at `src/screens/home/HomeScreen.tsx`
- HomeScreen already has header with gym name and "Changer" button
- Tapping "Changer" clears gym and navigates to GymMapScreen via `navigation.reset()`
- gymStore has `selectedGym`, `setSelectedGym`, `clearSelectedGym`
- Zustand persistence working with AsyncStorage

### Current HomeScreen Header Implementation
[Source: blocus/src/screens/home/HomeScreen.tsx]

```typescript
// Current header in HomeScreen:
<View style={styles.header}>
  <Pressable style={styles.gymSelector} onPress={handleChangeGym} testID="change-gym-button">
    <MapPin size={24} color={colors.primary} weight="fill" />
    <Text style={styles.gymName} numberOfLines={1}>
      {selectedGym?.name ?? 'Aucune salle'}
    </Text>
    <Text style={styles.changeText}>Changer</Text>
  </Pressable>
</View>

const handleChangeGym = () => {
  clearSelectedGym();
  navigation.reset({
    index: 0,
    routes: [{ name: 'GymMap' }],
  });
};
```

### Current ProfileScreen Implementation
[Source: blocus/src/screens/profile/ProfileScreen.tsx]

ProfileScreen is a placeholder with User icon and "Coming in Epic 4" text. Needs to be updated to show current gym and allow switching.

### Component Architecture
[Source: docs/architecture/frontend-architecture.md#component-architecture]

Layout components location: `src/components/layout/`
Gym domain components location: `src/components/gym/`

For GymHeader, use `src/components/gym/GymHeader.tsx` following existing component patterns.

### Navigation Patterns for Cross-Tab Navigation
[Source: docs/architecture/frontend-architecture.md#navigation-implementation]

For navigating from Profile to GymMap (different tab), options:
1. Use root navigation to reset to Explore tab with GymMap
2. Present GymMap as modal
3. Navigate to Explore tab then to GymMap

Recommended approach: Use similar pattern as HomeScreen - reset navigation state.

### Colors Reference
[Source: blocus/src/theme/colors.ts]

- `colors.primary`: #FF6B35 (accent color, icons)
- `colors.textPrimary`: #212529 (main text)
- `colors.textSecondary`: #6C757D (secondary text, placeholders)
- `colors.background`: #F8F9FA (screen background)
- `colors.white`: #FFFFFF (card backgrounds)
- `colors.black`: #000000 (shadows)
- `colors.primaryLight`: light version for badges

### File Locations
[Source: docs/architecture/project-structure.md]

**Create:**
- `src/components/gym/GymHeader.tsx`
- `__tests__/components/gym/GymHeader.test.tsx`

**Modify:**
- `src/screens/home/HomeScreen.tsx` - Use GymHeader component
- `src/screens/profile/ProfileScreen.tsx` - Add gym section and change button

---

## Testing

### Test File Locations
- `__tests__/components/gym/GymHeader.test.tsx` - New test file
- `__tests__/screens/profile/ProfileScreen.test.tsx` - Update existing

### Testing Standards
[Source: docs/architecture/testing-strategy.md]

- **Framework:** Jest 29.x + React Native Testing Library
- **Coverage target:** 80%+ for unit tests
- **Mock patterns:** Mock navigation, mock gymStore

### Testing Requirements for This Story

**Unit Tests:**
- `GymHeader`: Renders gym name, handles tap to change
- `ProfileScreen`: Shows current gym, has change button, triggers navigation

**Manual Testing:**
1. Home tab -> Header shows gym name -> Tap -> Goes to map
2. Profile tab -> Shows current gym -> Tap "Changer de salle" -> Goes to map
3. Select new gym from map -> Updates everywhere
4. Verify both switching methods work correctly

**Verification Commands:**
```bash
# Type check
npx tsc --noEmit

# Lint
npm run lint

# Tests
npm test
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 0.1 | Initial draft | SM (create-next-story) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript compilation: PASS
- ESLint: PASS (0 errors after fix)
- Jest: 49 tests passing (9 new tests added)

### Completion Notes List
- Reviewed existing header implementation in HomeScreen - ACs 1-3 already implemented in Story 2.2
- Created GymHeader reusable component at `src/components/gym/GymHeader.tsx`
- Refactored HomeScreen to use GymHeader component
- Updated ProfileScreen with "Salle actuelle" section showing current gym
- Added "Changer de salle" button in ProfileScreen with cross-tab navigation
- Used `CommonActions.reset` for navigating from Profile tab to Explore tab GymMap
- Added 5 tests for GymHeader component
- Added 4 tests for ProfileScreen gym switching functionality

### File List
**Created:**
- `src/components/gym/GymHeader.tsx`
- `__tests__/components/gym/GymHeader.test.tsx`

**Modified:**
- `src/screens/home/HomeScreen.tsx` - Refactored to use GymHeader component
- `src/screens/profile/ProfileScreen.tsx` - Added gym section with change functionality
- `__tests__/screens/profile/ProfileScreen.test.tsx` - Added tests for gym switching

---

## QA Results

### Review Date: 2026-01-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Clean implementation with proper component extraction. GymHeader is now a reusable component, and cross-tab navigation works correctly using CommonActions.reset.

### Refactoring Performed

None required - code quality is high and follows established patterns.

### Compliance Check

- Coding Standards: ESLint passes, consistent code style
- Project Structure: Files in correct locations per architecture docs
- Testing Strategy: 49 unit tests (80%+ coverage target met)
- All ACs Met: All 4 acceptance criteria verified

### Improvements Checklist

All items addressed by developer:

- [x] GymHeader extracted as reusable component
- [x] HomeScreen refactored to use GymHeader
- [x] ProfileScreen shows current gym with "Salle actuelle" section
- [x] Cross-tab navigation from Profile to GymMap working
- [x] Tests for GymHeader component (5 tests)
- [x] Tests for ProfileScreen gym switching (5 tests)

No outstanding items.

### Security Review

No security concerns - UI-only changes with local state management.

### Performance Considerations

No performance issues - lightweight component extraction.

### Files Modified During Review

None - no refactoring needed.

### Gate Status

Gate: **PASS** -> docs/qa/gates/2.4-gym-header-switching.yml

### Recommended Status

Ready for Done - All acceptance criteria met, tests passing, code quality excellent.
