# Story 1.3: Canary Screen & Health Check

## Status

**Done**

---

## Story

**As a** developer,
**I want** a canary screen that displays data from Supabase,
**so that** I can verify the full stack is working end-to-end.

---

## Acceptance Criteria

1. Écran "Home" placeholder affichant un message de bienvenue
2. Requête Supabase pour récupérer la liste des gyms (même vide)
3. Affichage du nombre de gyms ou message "Aucune salle" si vide
4. Gestion des états de chargement et d'erreur
5. Firebase Crashlytics intégré et configuré
6. Un crash test peut être déclenché (bouton caché en dev) pour valider Crashlytics

---

## Tasks / Subtasks

- [x] **Task 1: Refactor ExploreScreen to HomeScreen Pattern** (AC: 1, 2, 3, 4)
  - [x] Update ExploreScreen to be a proper "Home" screen with welcome message
  - [x] Keep the existing Supabase connection test logic
  - [x] Create proper loading state with LoadingSpinner component
  - [x] Create proper error state with retry functionality
  - [x] Display gym count or empty state message

- [x] **Task 2: Create Reusable UI Components** (AC: 1, 4)
  - [x] Create `src/components/ui/LoadingSpinner.tsx`
  - [x] Create `src/components/layout/EmptyState.tsx`
  - [x] Create `src/components/layout/ErrorState.tsx` for error display with retry

- [x] **Task 3: Create useGyms Hook with React Query** (AC: 2, 3)
  - [x] Create `src/hooks/useGyms.ts` with `useGyms()` hook
  - [x] Use React Query for data fetching and caching
  - [x] Create `src/services/api/gyms.ts` with `getGyms()` function
  - [x] Handle loading, error, and empty states

- [x] **Task 4: Install and Configure Firebase Crashlytics** (AC: 5)
  - [x] Install `@react-native-firebase/app` and `@react-native-firebase/crashlytics`
  - [x] Configure Expo plugin in app.json
  - [x] Create `src/lib/crashlytics.ts` with helper functions
  - [x] Add ErrorBoundary provider to App.tsx

- [x] **Task 5: Implement Crash Test Button** (AC: 6)
  - [x] Add hidden crash test button in HomeScreen (only visible in __DEV__ mode)
  - [x] Button triggers `crashlytics().crash()` to test integration
  - [x] Verify crash appears in Firebase Console

- [x] **Task 6: Create Health Check Utility** (AC: 4)
  - [x] Create `src/lib/health.ts` with health check functions
  - [x] Implement `checkSupabase()` and `checkNetwork()` functions
  - [x] Display health status in HomeScreen (dev mode)

- [x] **Task 7: Write Unit Tests** (AC: All)
  - [x] Test LoadingSpinner component
  - [x] Test EmptyState component
  - [x] Test useGyms hook with mocked Supabase
  - [x] Test gyms service functions

- [x] **Task 8: Verification & Integration Testing**
  - [x] Run `npx tsc --noEmit` - verify no type errors
  - [x] Run `npm run lint` - verify no lint errors
  - [x] Run `npm test` - verify all tests pass
  - [x] Manual test: App loads and shows gym count
  - [x] Manual test: Crash button works in dev mode

---

## Dev Notes

### Previous Story Context (Story 1.2)
[Source: docs/stories/1.2.story.md]

- Supabase client configured at `src/lib/supabase.ts`
- Database types at `src/types/database.ts`
- Model types at `src/types/models/`
- Connection test already exists in ExploreScreen (can be refactored)
- React Query provider already configured in `src/providers/QueryProvider.tsx`

### Firebase Crashlytics Configuration
[Source: architecture/monitoring-observability.md]

**Crashlytics Helper Module:**
```typescript
// src/lib/crashlytics.ts
import crashlytics from '@react-native-firebase/crashlytics';

export const Crashlytics = {
  setUser: (userId: string) => {
    crashlytics().setUserId(userId);
  },
  log: (message: string) => {
    crashlytics().log(message);
  },
  recordError: (error: Error, context?: Record<string, string>) => {
    if (context) {
      Object.entries(context).forEach(([key, value]) => {
        crashlytics().setAttribute(key, value);
      });
    }
    crashlytics().recordError(error);
  },
};
```

### ErrorBoundary Implementation
[Source: architecture/monitoring-observability.md]

ErrorBoundary should wrap the app to catch React errors and report to Crashlytics.

### Health Check Utility
[Source: architecture/monitoring-observability.md]

```typescript
// src/lib/health.ts
export const Health = {
  checkSupabase: async (): Promise<boolean> => {
    try {
      const { error } = await supabase.from('gyms').select('id').limit(1);
      return !error;
    } catch {
      return false;
    }
  },
  checkNetwork: async (): Promise<boolean> => {
    const state = await NetInfo.fetch();
    return state.isConnected ?? false;
  },
  getStatus: async () => ({
    network: await Health.checkNetwork(),
    api: await Health.checkSupabase(),
    timestamp: new Date().toISOString(),
  }),
};
```

### React Query Hook Pattern
[Source: architecture/frontend-architecture.md#state-management-flow]

Custom hooks encapsulate data fetching logic:
```typescript
// src/hooks/useGyms.ts
import { useQuery } from '@tanstack/react-query';
import { getGyms } from '@/services/api/gyms';

export function useGyms() {
  return useQuery({
    queryKey: ['gyms'],
    queryFn: getGyms,
  });
}
```

### Service Layer Pattern
[Source: architecture/frontend-architecture.md#state-management-flow]

Services abstract Supabase client:
```typescript
// src/services/api/gyms.ts
import { supabase } from '@/lib/supabase';
import type { Tables } from '@/types/database';

export async function getGyms(): Promise<Tables<'gyms'>[]> {
  const { data, error } = await supabase
    .from('gyms')
    .select('*')
    .order('name');

  if (error) throw error;
  return data ?? [];
}
```

### Component File Locations
[Source: architecture/project-structure.md]

- `src/components/ui/LoadingSpinner.tsx`
- `src/components/layout/EmptyState.tsx`
- `src/components/layout/ErrorBoundary.tsx`
- `src/hooks/useGyms.ts`
- `src/services/api/gyms.ts`
- `src/lib/crashlytics.ts`
- `src/lib/health.ts`

### Tech Stack References
[Source: architecture/tech-stack.md]

- **Crash Reporting:** @react-native-firebase/crashlytics 20.x
- **State Management:** React Query (TanStack) 5.x
- **Testing:** Jest 29.x + React Native Testing Library 12.x

### Testing Strategy
[Source: architecture/testing-strategy.md]

- Unit tests: 80%+ coverage target for components, hooks, utils
- Mock Supabase for service tests
- Use React Query test utilities for hook tests

---

## Testing

### Test File Location
`__tests__/` at project root

### Testing Standards
[Source: architecture/testing-strategy.md]

- **Framework:** Jest 29.x + React Native Testing Library 12.x
- **Coverage target:** 80%+ for unit tests

### Testing Requirements for This Story

**Unit Tests:**
- `__tests__/components/ui/LoadingSpinner.test.tsx`
- `__tests__/components/layout/EmptyState.test.tsx`
- `__tests__/hooks/useGyms.test.tsx`
- `__tests__/services/api/gyms.test.ts`

**Manual Testing:**
- Verify HomeScreen displays loading state initially
- Verify gym count or empty state displays after load
- Verify error state with retry button on network failure
- Verify crash test button triggers Crashlytics (dev mode)
- Verify crash appears in Firebase Console

**Verification Commands:**
```bash
# Type check
npx tsc --noEmit

# Lint
npm run lint

# Tests
npm test
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 0.1 | Initial draft | SM (create-next-story) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Jest/Expo compatibility issues resolved by using react-native preset instead of jest-expo
- react-test-renderer version mismatch fixed (19.2.3 → 19.1.0)

### Completion Notes List
- All 8 tasks completed successfully
- TypeScript: No errors
- Lint: No errors
- Tests: 14 passing (4 test suites)
- Firebase Crashlytics configured with ErrorBoundary
- Health check utility displays network and API status in dev mode

### File List
**New Files:**
- `src/components/ui/LoadingSpinner.tsx` - Loading indicator component
- `src/components/layout/EmptyState.tsx` - Empty state display component
- `src/components/layout/ErrorState.tsx` - Error state with retry button
- `src/hooks/useGyms.ts` - React Query hook for gyms data
- `src/services/api/gyms.ts` - Supabase service for gyms
- `src/lib/crashlytics.ts` - Firebase Crashlytics helper module
- `src/lib/health.ts` - Health check utility (network + API)
- `src/providers/ErrorBoundary.tsx` - React error boundary with Crashlytics
- `jest.config.js` - Jest configuration
- `jest.setup.js` - Jest setup with mocks
- `__tests__/components/ui/LoadingSpinner.test.tsx`
- `__tests__/components/layout/EmptyState.test.tsx`
- `__tests__/hooks/useGyms.test.tsx`
- `__tests__/services/api/gyms.test.ts`

**Modified Files:**
- `App.tsx` - Added ErrorBoundary provider
- `app.json` - Added Firebase plugins configuration
- `package.json` - Added test scripts and dependencies
- `src/screens/explore/ExploreScreen.tsx` - Refactored to Home pattern with health check and crash test

---

## QA Results

### Review Date: 2026-01-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - The implementation is clean, well-structured, and follows established patterns. All acceptance criteria are met with appropriate test coverage. The code demonstrates good separation of concerns with reusable components, proper service layer abstraction, and comprehensive error handling.

**Highlights:**
- Clean component architecture with proper TypeScript interfaces
- Consistent use of design system colors and styling patterns
- Proper React Query integration for server state management
- Firebase Crashlytics correctly integrated with ErrorBoundary
- Health check utility provides valuable dev debugging info
- All tests passing (14 tests across 4 suites)

### Refactoring Performed

None required - the code quality is already high.

### Compliance Check

- Coding Standards: ✓ ESLint passes, consistent formatting
- Project Structure: ✓ Files in correct locations per architecture docs
- Testing Strategy: ✓ Unit tests for components, hooks, and services
- All ACs Met: ✓ All 6 acceptance criteria satisfied

### Requirements Traceability

| AC | Description | Implementation | Test Coverage |
|----|-------------|----------------|---------------|
| 1 | Home screen with welcome message | ExploreScreen with "Bienvenue sur Blocus" | ✓ (visual) |
| 2 | Supabase query for gyms | useGyms hook + gyms service | ✓ useGyms.test.tsx, gyms.test.ts |
| 3 | Display gym count or empty state | EmptyState component + count display | ✓ EmptyState.test.tsx |
| 4 | Loading and error states | LoadingSpinner + ErrorState components | ✓ LoadingSpinner.test.tsx |
| 5 | Firebase Crashlytics integrated | crashlytics.ts + ErrorBoundary | ✓ (mocked in tests) |
| 6 | Dev crash test button | Hidden button in __DEV__ mode | ✓ (visual) |

### Improvements Checklist

- [x] All components properly typed with TypeScript interfaces
- [x] Error boundaries catch and report errors to Crashlytics
- [x] Health check displays network and API status in dev mode
- [x] Jest configuration working with React Native
- [ ] Consider adding ErrorState test (currently missing dedicated test file)
- [ ] Consider adding test for health.ts utility

### Security Review

No security concerns - this is a canary/health check story with read-only operations.

### Performance Considerations

- React Query provides automatic caching and background refetching
- Health check runs once on mount (appropriate for dev debugging)
- No unnecessary re-renders detected

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** → docs/qa/gates/1.3-canary-screen-health-check.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, tests passing, code quality excellent.
